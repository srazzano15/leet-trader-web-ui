"use client";
import { useEffect, useState, useRef } from "react";
import axios from "axios";
import moment from "moment";
import * as d3 from "d3";

interface StockData {
  c: number; // close
  h: number; // high
  l: number; // low
  o: number; // open
  t: Date; // time
  v: number; // volume
  vw: number; // vwap
}

const CandlestickChart: React.FC = () => {
  const [data, setData] = useState([]);
  const svgRef = useRef<SVGSVGElement | null>(null);

  /**
     * 
     * {
  "bars": {
    "AAPL": [
      {
        "c": 228.835,
        "h": 229.39,
        "l": 228.205,
        "n": 483,
        "o": 229.24,
        "t": "2024-10-31T13:30:00Z",
        "v": 56305,
        "vw": 228.633289
      }
        ...
     */
  let width = 640;
  let height = 400;
  /*   useEffect(() => {
    (async () => {
      try {
        const response = await axios.get(
          "https://data.alpaca.markets/v2/stocks/AAPL/bars?timeframe=5Min&start=2024-10-15&limit=1000&adjustment=raw&feed=iex&sort=asc",
          {
            headers: {
              accept: "application/json",
              "APCA-API-KEY-ID": "PKXVKQTFW701A3PJAPBQ",
              "APCA-API-SECRET-KEY": "LfaD2SZnbjrZMhuGNrnMHU8zWFJGNBO2LuwghaEE",
            },
          }
        );

        const transformed = response.data.bars.map((bar: any) => {
          bar.t = new Date(bar.t);
          return bar;
        });
        setData(response.data.bars);
        //setData(transformed);
      } catch (error) {
        console.error("error: ", error);
      }
    })();
  }, []); */

  useEffect(() => {
    const testData = [
      {
        c: 224.3,
        h: 224.4,
        l: 222.61,
        n: 1276,
        o: 224.34,
        t: "2024-08-01T13:00:00Z",
        v: 119343,
        vw: 223.490614,
      },
      {
        c: 220.985,
        h: 224.23,
        l: 220.39,
        n: 2221,
        o: 224.23,
        t: "2024-08-01T14:00:00Z",
        v: 213677,
        vw: 222.128255,
      },
      {
        c: 219.805,
        h: 221.16,
        l: 219.21,
        n: 2039,
        o: 220.905,
        t: "2024-08-01T15:00:00Z",
        v: 178539,
        vw: 220.201517,
      },
      {
        c: 218.735,
        h: 220.17,
        l: 218.47,
        n: 1906,
        o: 219.75,
        t: "2024-08-01T16:00:00Z",
        v: 169488,
        vw: 219.403581,
      },
      {
        c: 218.64,
        h: 218.9,
        l: 217.205,
        n: 1283,
        o: 218.7,
        t: "2024-08-01T17:00:00Z",
        v: 107992,
        vw: 218.001129,
      },
      {
        c: 217.41,
        h: 218.78,
        l: 217.03,
        n: 1517,
        o: 218.585,
        t: "2024-08-01T18:00:00Z",
        v: 147713,
        vw: 217.651139,
      },
      {
        c: 218.51,
        h: 219.105,
        l: 217.17,
        n: 3371,
        o: 217.5,
        t: "2024-08-01T19:00:00Z",
        v: 368858,
        vw: 218.060413,
      },
      {
        c: 218.19,
        h: 221.02,
        l: 216.65,
        n: 60,
        o: 216.65,
        t: "2024-08-01T20:00:00Z",
        v: 3238,
        vw: 217.735333,
      },
      {
        c: 216.7,
        h: 216.7,
        l: 216.7,
        n: 2,
        o: 216.7,
        t: "2024-08-02T12:00:00Z",
        v: 110,
        vw: 216.7,
      },
      {
        c: 223.24,
        h: 224.365,
        l: 217.77,
        n: 3408,
        o: 219.06,
        t: "2024-08-02T13:00:00Z",
        v: 463849,
        vw: 221.650879,
      },
      {
        c: 222.37,
        h: 224.36,
        l: 220.715,
        n: 4510,
        o: 223.3,
        t: "2024-08-02T14:00:00Z",
        v: 359982,
        vw: 222.731358,
      },
      {
        c: 223.23,
        h: 223.655,
        l: 221.44,
        n: 2841,
        o: 222.35,
        t: "2024-08-02T15:00:00Z",
        v: 279644,
        vw: 222.771566,
      },
      {
        c: 224.235,
        h: 225.57,
        l: 222.735,
        n: 2462,
        o: 223.135,
        t: "2024-08-02T16:00:00Z",
        v: 260436,
        vw: 224.080694,
      },
      {
        c: 224.17,
        h: 225.25,
        l: 223.33,
        n: 1368,
        o: 224.2,
        t: "2024-08-02T17:00:00Z",
        v: 165500,
        vw: 224.622855,
      },
      {
        c: 222.7,
        h: 224.22,
        l: 221.96,
        n: 1702,
        o: 224.22,
        t: "2024-08-02T18:00:00Z",
        v: 151645,
        vw: 223.178908,
      },
      {
        c: 219.81,
        h: 223.34,
        l: 219.08,
        n: 5622,
        o: 222.72,
        t: "2024-08-02T19:00:00Z",
        v: 578003,
        vw: 220.897562,
      },
      {
        c: 202.49,
        h: 202.49,
        l: 202.49,
        n: 2,
        o: 202.49,
        t: "2024-08-05T12:00:00Z",
        v: 111,
        vw: 202.49,
      },
      {
        c: 207.805,
        h: 210.965,
        l: 196,
        n: 5967,
        o: 199.16,
        t: "2024-08-05T13:00:00Z",
        v: 697849,
        vw: 205.973874,
      },
      {
        c: 209.39,
        h: 210.95,
        l: 207.775,
        n: 4712,
        o: 207.87,
        t: "2024-08-05T14:00:00Z",
        v: 356305,
        vw: 209.179384,
      },
      {
        c: 210.35,
        h: 213.45,
        l: 208.805,
        n: 2677,
        o: 209.575,
        t: "2024-08-05T15:00:00Z",
        v: 261800,
        vw: 211.046823,
      },
      {
        c: 210.36,
        h: 212.91,
        l: 209.72,
        n: 1968,
        o: 210.51,
        t: "2024-08-05T16:00:00Z",
        v: 160665,
        vw: 211.366313,
      },
      {
        c: 210.76,
        h: 211.84,
        l: 209.965,
        n: 2039,
        o: 210.34,
        t: "2024-08-05T17:00:00Z",
        v: 115138,
        vw: 211.148433,
      },
      {
        c: 204.77,
        h: 210.92,
        l: 203.945,
        n: 3468,
        o: 210.88,
        t: "2024-08-05T18:00:00Z",
        v: 439971,
        vw: 206.837807,
      },
      {
        c: 209.23,
        h: 209.25,
        l: 204.09,
        n: 4638,
        o: 204.835,
        t: "2024-08-05T19:00:00Z",
        v: 514389,
        vw: 207.259053,
      },
      {
        c: 210.42,
        h: 210.42,
        l: 209.12,
        n: 7,
        o: 209.12,
        t: "2024-08-05T20:00:00Z",
        v: 1484,
        vw: 210.12,
      },
      {
        c: 205.77,
        h: 207.07,
        l: 205.77,
        n: 16,
        o: 207.07,
        t: "2024-08-06T12:00:00Z",
        v: 835,
        vw: 206.3675,
      },
      {
        c: 203.13,
        h: 206.45,
        l: 201.1,
        n: 2277,
        o: 205.88,
        t: "2024-08-06T13:00:00Z",
        v: 241173,
        vw: 203.873082,
      },
      {
        c: 207.58,
        h: 207.66,
        l: 202.465,
        n: 2902,
        o: 203,
        t: "2024-08-06T14:00:00Z",
        v: 309275,
        vw: 205.36605,
      },
      {
        c: 208.48,
        h: 208.515,
        l: 206.06,
        n: 2440,
        o: 207.57,
        t: "2024-08-06T15:00:00Z",
        v: 200659,
        vw: 207.178448,
      },
      {
        c: 209.725,
        h: 209.98,
        l: 208.29,
        n: 1693,
        o: 208.445,
        t: "2024-08-06T16:00:00Z",
        v: 134396,
        vw: 208.930712,
      },
      {
        c: 208.545,
        h: 209.7,
        l: 208.38,
        n: 1471,
        o: 209.7,
        t: "2024-08-06T17:00:00Z",
        v: 115366,
        vw: 208.965498,
      },
      {
        c: 208.805,
        h: 209.925,
        l: 207.775,
        n: 1245,
        o: 208.465,
        t: "2024-08-06T18:00:00Z",
        v: 94689,
        vw: 208.986644,
      },
      {
        c: 207.14,
        h: 208.83,
        l: 206.41,
        n: 3605,
        o: 208.745,
        t: "2024-08-06T19:00:00Z",
        v: 332489,
        vw: 207.598303,
      },
      {
        c: 212.37,
        h: 212.39,
        l: 206.45,
        n: 822,
        o: 206.9,
        t: "2024-08-07T13:00:00Z",
        v: 77021,
        vw: 210.043082,
      },
      {
        c: 213.135,
        h: 213.46,
        l: 210.825,
        n: 1513,
        o: 212.5,
        t: "2024-08-07T14:00:00Z",
        v: 128047,
        vw: 212.294101,
      },
      {
        c: 212.56,
        h: 213.625,
        l: 211.96,
        n: 1235,
        o: 213,
        t: "2024-08-07T15:00:00Z",
        v: 120380,
        vw: 213.078486,
      },
      {
        c: 211.56,
        h: 212.95,
        l: 211.215,
        n: 839,
        o: 212.555,
        t: "2024-08-07T16:00:00Z",
        v: 63576,
        vw: 212.115409,
      },
      {
        c: 210.95,
        h: 211.81,
        l: 210.39,
        n: 989,
        o: 211.68,
        t: "2024-08-07T17:00:00Z",
        v: 83511,
        vw: 211.076759,
      },
      {
        c: 208.91,
        h: 211.24,
        l: 208.91,
        n: 900,
        o: 210.9,
        t: "2024-08-07T18:00:00Z",
        v: 81848,
        vw: 209.99945,
      },
      {
        c: 209.81,
        h: 210.97,
        l: 208.54,
        n: 1873,
        o: 209.02,
        t: "2024-08-07T19:00:00Z",
        v: 169563,
        vw: 210.229839,
      },
      {
        c: 210.6,
        h: 213.11,
        l: 208.91,
        n: 881,
        o: 213.09,
        t: "2024-08-08T13:00:00Z",
        v: 79768,
        vw: 211.701529,
      },
      {
        c: 212.2,
        h: 212.91,
        l: 210.545,
        n: 1528,
        o: 210.645,
        t: "2024-08-08T14:00:00Z",
        v: 108930,
        vw: 212.059523,
      },
      {
        c: 212.41,
        h: 212.68,
        l: 211.095,
        n: 1273,
        o: 212.21,
        t: "2024-08-08T15:00:00Z",
        v: 111027,
        vw: 211.94267,
      },
      {
        c: 213.12,
        h: 213.46,
        l: 212.26,
        n: 1405,
        o: 212.35,
        t: "2024-08-08T16:00:00Z",
        v: 141848,
        vw: 212.902559,
      },
      {
        c: 213.69,
        h: 214.2,
        l: 212.69,
        n: 987,
        o: 213.23,
        t: "2024-08-08T17:00:00Z",
        v: 126907,
        vw: 213.713726,
      },
      {
        c: 212.93,
        h: 213.8,
        l: 212.655,
        n: 1106,
        o: 213.6,
        t: "2024-08-08T18:00:00Z",
        v: 93606,
        vw: 213.160955,
      },
      {
        c: 213.35,
        h: 213.52,
        l: 211.905,
        n: 2791,
        o: 212.895,
        t: "2024-08-08T19:00:00Z",
        v: 173421,
        vw: 212.67741,
      },
      {
        c: 212.56,
        h: 213.42,
        l: 211.99,
        n: 1117,
        o: 212.06,
        t: "2024-08-09T13:00:00Z",
        v: 103064,
        vw: 212.716768,
      },
      {
        c: 214.745,
        h: 215.17,
        l: 212.36,
        n: 1603,
        o: 212.6,
        t: "2024-08-09T14:00:00Z",
        v: 133452,
        vw: 214.112342,
      },
      {
        c: 214.64,
        h: 215.72,
        l: 214.555,
        n: 1406,
        o: 214.82,
        t: "2024-08-09T15:00:00Z",
        v: 128641,
        vw: 215.258586,
      },
      {
        c: 215.4,
        h: 215.42,
        l: 214.44,
        n: 1094,
        o: 214.78,
        t: "2024-08-09T16:00:00Z",
        v: 87666,
        vw: 214.764095,
      },
      {
        c: 215.93,
        h: 216.74,
        l: 215.26,
        n: 1151,
        o: 215.43,
        t: "2024-08-09T17:00:00Z",
        v: 100443,
        vw: 216.140559,
      },
      {
        c: 215.6,
        h: 216.05,
        l: 214.93,
        n: 1089,
        o: 215.89,
        t: "2024-08-09T18:00:00Z",
        v: 122883,
        vw: 215.307518,
      },
      {
        c: 216.16,
        h: 216.59,
        l: 215.24,
        n: 3175,
        o: 215.595,
        t: "2024-08-09T19:00:00Z",
        v: 234366,
        vw: 216.072755,
      },
      {
        c: 217.05,
        h: 217.52,
        l: 215.63,
        n: 866,
        o: 216.07,
        t: "2024-08-12T13:00:00Z",
        v: 72554,
        vw: 216.809263,
      },
      {
        c: 218.595,
        h: 219.08,
        l: 216.94,
        n: 1504,
        o: 217,
        t: "2024-08-12T14:00:00Z",
        v: 130638,
        vw: 218.170779,
      },
      {
        c: 218.68,
        h: 219.5,
        l: 217.2,
        n: 1154,
        o: 218.63,
        t: "2024-08-12T15:00:00Z",
        v: 87502,
        vw: 218.225375,
      },
      {
        c: 217.26,
        h: 218.715,
        l: 217.2,
        n: 737,
        o: 218.715,
        t: "2024-08-12T16:00:00Z",
        v: 46274,
        vw: 218.134878,
      },
      {
        c: 216.865,
        h: 217.67,
        l: 216.5,
        n: 670,
        o: 217.11,
        t: "2024-08-12T17:00:00Z",
        v: 54208,
        vw: 217.234072,
      },
      {
        c: 217.37,
        h: 217.37,
        l: 216.585,
        n: 980,
        o: 216.87,
        t: "2024-08-12T18:00:00Z",
        v: 63883,
        vw: 216.959242,
      },
      {
        c: 217.6,
        h: 217.61,
        l: 216.63,
        n: 1458,
        o: 217.42,
        t: "2024-08-12T19:00:00Z",
        v: 108751,
        vw: 217.076257,
      },
      {
        c: 221.115,
        h: 221.35,
        l: 219.185,
        n: 1250,
        o: 219.185,
        t: "2024-08-13T13:00:00Z",
        v: 116204,
        vw: 220.451622,
      },
      {
        c: 220.96,
        h: 221.69,
        l: 220.3,
        n: 1452,
        o: 221.2,
        t: "2024-08-13T14:00:00Z",
        v: 109797,
        vw: 220.844997,
      },
      {
        c: 221.12,
        h: 221.59,
        l: 220.93,
        n: 868,
        o: 221.01,
        t: "2024-08-13T15:00:00Z",
        v: 59420,
        vw: 221.184961,
      },
      {
        c: 221.585,
        h: 221.585,
        l: 220.93,
        n: 814,
        o: 221.1,
        t: "2024-08-13T16:00:00Z",
        v: 93467,
        vw: 221.234968,
      },
      {
        c: 220.92,
        h: 221.87,
        l: 220.57,
        n: 695,
        o: 221.575,
        t: "2024-08-13T17:00:00Z",
        v: 67581,
        vw: 221.379351,
      },
      {
        c: 221.21,
        h: 221.48,
        l: 220.72,
        n: 507,
        o: 220.94,
        t: "2024-08-13T18:00:00Z",
        v: 22659,
        vw: 221.194305,
      },
      {
        c: 221.21,
        h: 221.31,
        l: 220.44,
        n: 1698,
        o: 221.31,
        t: "2024-08-13T19:00:00Z",
        v: 118910,
        vw: 220.813793,
      },
      {
        c: 220.925,
        h: 221.98,
        l: 219.7,
        n: 990,
        o: 220.51,
        t: "2024-08-14T13:00:00Z",
        v: 82151,
        vw: 220.958203,
      },
      {
        c: 221.69,
        h: 221.72,
        l: 220.48,
        n: 1229,
        o: 220.965,
        t: "2024-08-14T14:00:00Z",
        v: 93561,
        vw: 221.233462,
      },
      {
        c: 222.96,
        h: 223,
        l: 221.64,
        n: 831,
        o: 221.705,
        t: "2024-08-14T15:00:00Z",
        v: 73729,
        vw: 222.346773,
      },
      {
        c: 221.04,
        h: 222.955,
        l: 220.395,
        n: 955,
        o: 222.955,
        t: "2024-08-14T16:00:00Z",
        v: 104733,
        vw: 221.415172,
      },
      {
        c: 221.295,
        h: 221.755,
        l: 220.985,
        n: 796,
        o: 220.985,
        t: "2024-08-14T17:00:00Z",
        v: 74779,
        vw: 221.379952,
      },
      {
        c: 221.525,
        h: 221.71,
        l: 220.96,
        n: 722,
        o: 221.195,
        t: "2024-08-14T18:00:00Z",
        v: 50579,
        vw: 221.347786,
      },
      {
        c: 221.63,
        h: 222.35,
        l: 220.86,
        n: 1507,
        o: 221.53,
        t: "2024-08-14T19:00:00Z",
        v: 140063,
        vw: 221.637484,
      },
      {
        c: 223.64,
        h: 223.64,
        l: 223.64,
        n: 1,
        o: 223.64,
        t: "2024-08-15T12:00:00Z",
        v: 100,
        vw: 223.64,
      },
      {
        c: 224.38,
        h: 224.85,
        l: 222.8,
        n: 1556,
        o: 224.6,
        t: "2024-08-15T13:00:00Z",
        v: 95850,
        vw: 223.560242,
      },
      {
        c: 224.45,
        h: 225.35,
        l: 223.98,
        n: 1792,
        o: 224.46,
        t: "2024-08-15T14:00:00Z",
        v: 162928,
        vw: 224.748601,
      },
      {
        c: 224.65,
        h: 224.805,
        l: 223.89,
        n: 981,
        o: 224.3,
        t: "2024-08-15T15:00:00Z",
        v: 83488,
        vw: 224.28694,
      },
      {
        c: 224.57,
        h: 225.015,
        l: 224.36,
        n: 965,
        o: 224.65,
        t: "2024-08-15T16:00:00Z",
        v: 92733,
        vw: 224.760952,
      },
      {
        c: 224.66,
        h: 224.855,
        l: 224.255,
        n: 886,
        o: 224.465,
        t: "2024-08-15T17:00:00Z",
        v: 67502,
        vw: 224.595226,
      },
      {
        c: 225.18,
        h: 225.18,
        l: 224.63,
        n: 678,
        o: 224.69,
        t: "2024-08-15T18:00:00Z",
        v: 46238,
        vw: 224.95954,
      },
      {
        c: 224.69,
        h: 225.32,
        l: 223.88,
        n: 2024,
        o: 225.11,
        t: "2024-08-15T19:00:00Z",
        v: 169756,
        vw: 224.700063,
      },
      {
        c: 224.11,
        h: 224.68,
        l: 223.67,
        n: 778,
        o: 223.98,
        t: "2024-08-16T13:00:00Z",
        v: 60759,
        vw: 224.119746,
      },
      {
        c: 224.17,
        h: 225.01,
        l: 223.975,
        n: 1049,
        o: 224.2,
        t: "2024-08-16T14:00:00Z",
        v: 70888,
        vw: 224.447482,
      },
      {
        c: 225.95,
        h: 226,
        l: 223.995,
        n: 947,
        o: 224.14,
        t: "2024-08-16T15:00:00Z",
        v: 78832,
        vw: 224.814017,
      },
      {
        c: 226.59,
        h: 226.8,
        l: 225.79,
        n: 793,
        o: 225.91,
        t: "2024-08-16T16:00:00Z",
        v: 57899,
        vw: 226.345018,
      },
      {
        c: 226.19,
        h: 226.66,
        l: 226.04,
        n: 705,
        o: 226.59,
        t: "2024-08-16T17:00:00Z",
        v: 52650,
        vw: 226.473913,
      },
      {
        c: 226.15,
        h: 226.18,
        l: 225.66,
        n: 698,
        o: 226.135,
        t: "2024-08-16T18:00:00Z",
        v: 43945,
        vw: 225.952067,
      },
      {
        c: 226.06,
        h: 226.19,
        l: 225.56,
        n: 1489,
        o: 226.08,
        t: "2024-08-16T19:00:00Z",
        v: 93483,
        vw: 225.946282,
      },
      {
        c: 224.39,
        h: 225.57,
        l: 224.14,
        n: 1052,
        o: 225.57,
        t: "2024-08-19T13:00:00Z",
        v: 87818,
        vw: 224.795756,
      },
      {
        c: 224.21,
        h: 224.505,
        l: 223.07,
        n: 1756,
        o: 224.41,
        t: "2024-08-19T14:00:00Z",
        v: 164407,
        vw: 223.94234,
      },
      {
        c: 223.88,
        h: 224.72,
        l: 223.82,
        n: 795,
        o: 224.22,
        t: "2024-08-19T15:00:00Z",
        v: 61805,
        vw: 224.334251,
      },
      {
        c: 224.37,
        h: 224.45,
        l: 223.81,
        n: 721,
        o: 223.825,
        t: "2024-08-19T16:00:00Z",
        v: 60529,
        vw: 224.278281,
      },
      {
        c: 224.28,
        h: 224.43,
        l: 223.76,
        n: 701,
        o: 224.315,
        t: "2024-08-19T17:00:00Z",
        v: 54511,
        vw: 224.0977,
      },
      {
        c: 224.745,
        h: 224.915,
        l: 224.29,
        n: 706,
        o: 224.29,
        t: "2024-08-19T18:00:00Z",
        v: 63532,
        vw: 224.629399,
      },
      {
        c: 225.82,
        h: 225.93,
        l: 224.67,
        n: 1758,
        o: 224.78,
        t: "2024-08-19T19:00:00Z",
        v: 145264,
        vw: 225.34531,
      },
      {
        c: 227.01,
        h: 227.165,
        l: 225.515,
        n: 1097,
        o: 225.83,
        t: "2024-08-20T13:00:00Z",
        v: 86668,
        vw: 226.494144,
      },
      {
        c: 225.96,
        h: 227.025,
        l: 225.75,
        n: 1613,
        o: 227.025,
        t: "2024-08-20T14:00:00Z",
        v: 113340,
        vw: 226.299526,
      },
      {
        c: 226.93,
        h: 226.955,
        l: 225.9,
        n: 1073,
        o: 225.965,
        t: "2024-08-20T15:00:00Z",
        v: 76941,
        vw: 226.403532,
      },
      {
        c: 226.5,
        h: 227.1,
        l: 226.49,
        n: 846,
        o: 226.94,
        t: "2024-08-20T16:00:00Z",
        v: 58188,
        vw: 226.883482,
      },
      {
        c: 226.765,
        h: 226.77,
        l: 226.15,
        n: 542,
        o: 226.56,
        t: "2024-08-20T17:00:00Z",
        v: 36572,
        vw: 226.569252,
      },
      {
        c: 226.55,
        h: 227.105,
        l: 226.545,
        n: 499,
        o: 226.665,
        t: "2024-08-20T18:00:00Z",
        v: 31293,
        vw: 226.865532,
      },
      {
        c: 226.53,
        h: 226.88,
        l: 226.23,
        n: 1361,
        o: 226.485,
        t: "2024-08-20T19:00:00Z",
        v: 114868,
        vw: 226.52081,
      },
      {
        c: 227.035,
        h: 227.06,
        l: 225.95,
        n: 590,
        o: 226.58,
        t: "2024-08-21T13:00:00Z",
        v: 49983,
        vw: 226.6323,
      },
      {
        c: 226.36,
        h: 227.97,
        l: 225.945,
        n: 1314,
        o: 227.075,
        t: "2024-08-21T14:00:00Z",
        v: 104148,
        vw: 227.114147,
      },
      {
        c: 226.22,
        h: 226.98,
        l: 225.78,
        n: 923,
        o: 226.23,
        t: "2024-08-21T15:00:00Z",
        v: 103328,
        vw: 226.462657,
      },
      {
        c: 226.445,
        h: 226.5,
        l: 225.72,
        n: 653,
        o: 226.125,
        t: "2024-08-21T16:00:00Z",
        v: 67748,
        vw: 226.133272,
      },
      {
        c: 226.21,
        h: 226.46,
        l: 225.84,
        n: 651,
        o: 226.4,
        t: "2024-08-21T17:00:00Z",
        v: 74780,
        vw: 226.126429,
      },
      {
        c: 226.45,
        h: 226.57,
        l: 225.88,
        n: 656,
        o: 226.23,
        t: "2024-08-21T18:00:00Z",
        v: 45007,
        vw: 226.293321,
      },
      {
        c: 226.32,
        h: 226.56,
        l: 225.24,
        n: 1835,
        o: 226.38,
        t: "2024-08-21T19:00:00Z",
        v: 131611,
        vw: 226.024828,
      },
      {
        c: 227.825,
        h: 228.32,
        l: 226.7,
        n: 976,
        o: 227.59,
        t: "2024-08-22T13:00:00Z",
        v: 90535,
        vw: 227.629904,
      },
      {
        c: 226.77,
        h: 228.28,
        l: 226.39,
        n: 1666,
        o: 228.04,
        t: "2024-08-22T14:00:00Z",
        v: 115385,
        vw: 227.133986,
      },
      {
        c: 225.535,
        h: 227.2,
        l: 224.925,
        n: 1500,
        o: 226.79,
        t: "2024-08-22T15:00:00Z",
        v: 111137,
        vw: 226.423272,
      },
      {
        c: 225.54,
        h: 226.6,
        l: 225.36,
        n: 928,
        o: 225.5,
        t: "2024-08-22T16:00:00Z",
        v: 55191,
        vw: 226.043403,
      },
      {
        c: 224.41,
        h: 225.81,
        l: 224.06,
        n: 1216,
        o: 225.45,
        t: "2024-08-22T17:00:00Z",
        v: 85711,
        vw: 224.915034,
      },
      {
        c: 224.42,
        h: 224.93,
        l: 223.91,
        n: 1204,
        o: 224.39,
        t: "2024-08-22T18:00:00Z",
        v: 80695,
        vw: 224.530594,
      },
      {
        c: 224.7,
        h: 224.92,
        l: 224.05,
        n: 2493,
        o: 224.5,
        t: "2024-08-22T19:00:00Z",
        v: 211131,
        vw: 224.397737,
      },
      {
        c: 227.04,
        h: 227.39,
        l: 225.545,
        n: 991,
        o: 225.96,
        t: "2024-08-23T13:00:00Z",
        v: 81781,
        vw: 226.730593,
      },
      {
        c: 226.27,
        h: 228.22,
        l: 225.56,
        n: 2379,
        o: 227.04,
        t: "2024-08-23T14:00:00Z",
        v: 183195,
        vw: 227.334796,
      },
      {
        c: 225.83,
        h: 226.74,
        l: 225.2,
        n: 1060,
        o: 226.165,
        t: "2024-08-23T15:00:00Z",
        v: 67596,
        vw: 226.057246,
      },
      {
        c: 225.32,
        h: 225.79,
        l: 224.36,
        n: 1081,
        o: 225.79,
        t: "2024-08-23T16:00:00Z",
        v: 95955,
        vw: 225.196715,
      },
      {
        c: 226.21,
        h: 226.49,
        l: 225.15,
        n: 624,
        o: 225.15,
        t: "2024-08-23T17:00:00Z",
        v: 37703,
        vw: 225.90895,
      },
      {
        c: 226.48,
        h: 226.7,
        l: 226.11,
        n: 700,
        o: 226.21,
        t: "2024-08-23T18:00:00Z",
        v: 54055,
        vw: 226.419465,
      },
      {
        c: 226.8,
        h: 227.16,
        l: 226.26,
        n: 1664,
        o: 226.485,
        t: "2024-08-23T19:00:00Z",
        v: 223963,
        vw: 226.881173,
      },
      {
        c: 226.34,
        h: 227.16,
        l: 226.07,
        n: 894,
        o: 226.745,
        t: "2024-08-26T13:00:00Z",
        v: 63910,
        vw: 226.530294,
      },
      {
        c: 224.84,
        h: 226.64,
        l: 223.93,
        n: 1924,
        o: 226.36,
        t: "2024-08-26T14:00:00Z",
        v: 160112,
        vw: 224.907226,
      },
      {
        c: 224.81,
        h: 225.39,
        l: 224.585,
        n: 936,
        o: 224.84,
        t: "2024-08-26T15:00:00Z",
        v: 70424,
        vw: 224.983279,
      },
      {
        c: 226.23,
        h: 226.23,
        l: 224.65,
        n: 1118,
        o: 224.75,
        t: "2024-08-26T16:00:00Z",
        v: 37649,
        vw: 225.574275,
      },
      {
        c: 225.6,
        h: 226.41,
        l: 225.48,
        n: 1615,
        o: 226.2,
        t: "2024-08-26T17:00:00Z",
        v: 50140,
        vw: 225.994268,
      },
      {
        c: 226.34,
        h: 226.34,
        l: 225.49,
        n: 636,
        o: 225.58,
        t: "2024-08-26T18:00:00Z",
        v: 45821,
        vw: 225.893281,
      },
      {
        c: 227.24,
        h: 227.27,
        l: 226.135,
        n: 1450,
        o: 226.28,
        t: "2024-08-26T19:00:00Z",
        v: 108558,
        vw: 226.674037,
      },
      {
        c: 226.79,
        h: 226.835,
        l: 224.93,
        n: 1015,
        o: 225.995,
        t: "2024-08-27T13:00:00Z",
        v: 86500,
        vw: 225.82421,
      },
      {
        c: 228.32,
        h: 228.32,
        l: 226.795,
        n: 1607,
        o: 226.795,
        t: "2024-08-27T14:00:00Z",
        v: 148799,
        vw: 227.558789,
      },
      {
        c: 228.19,
        h: 228.845,
        l: 227.98,
        n: 1014,
        o: 228.41,
        t: "2024-08-27T15:00:00Z",
        v: 85531,
        vw: 228.515998,
      },
      {
        c: 228.085,
        h: 228.46,
        l: 227.6,
        n: 784,
        o: 228.17,
        t: "2024-08-27T16:00:00Z",
        v: 51669,
        vw: 228.067916,
      },
      {
        c: 228.55,
        h: 228.64,
        l: 227.845,
        n: 795,
        o: 228.12,
        t: "2024-08-27T17:00:00Z",
        v: 64607,
        vw: 228.290741,
      },
      {
        c: 228.44,
        h: 228.56,
        l: 228.27,
        n: 624,
        o: 228.535,
        t: "2024-08-27T18:00:00Z",
        v: 31782,
        vw: 228.432528,
      },
      {
        c: 228.13,
        h: 228.42,
        l: 227.75,
        n: 1549,
        o: 228.415,
        t: "2024-08-27T19:00:00Z",
        v: 110884,
        vw: 228.052302,
      },
      {
        c: 228.21,
        h: 228.27,
        l: 228.21,
        n: 3,
        o: 228.27,
        t: "2024-08-28T12:00:00Z",
        v: 250,
        vw: 228.24,
      },
      {
        c: 228.6,
        h: 229.63,
        l: 227.71,
        n: 938,
        o: 227.71,
        t: "2024-08-28T13:00:00Z",
        v: 80432,
        vw: 228.824641,
      },
      {
        c: 227.52,
        h: 229.85,
        l: 227.45,
        n: 2014,
        o: 228.625,
        t: "2024-08-28T14:00:00Z",
        v: 163052,
        vw: 228.916583,
      },
      {
        c: 226.85,
        h: 227.68,
        l: 226.29,
        n: 1436,
        o: 227.27,
        t: "2024-08-28T15:00:00Z",
        v: 112374,
        vw: 226.794331,
      },
      {
        c: 227.57,
        h: 227.57,
        l: 226.66,
        n: 1185,
        o: 226.84,
        t: "2024-08-28T16:00:00Z",
        v: 86358,
        vw: 227.100041,
      },
      {
        c: 225.91,
        h: 227.75,
        l: 225.82,
        n: 846,
        o: 227.51,
        t: "2024-08-28T17:00:00Z",
        v: 53552,
        vw: 226.986224,
      },
      {
        c: 227.18,
        h: 227.22,
        l: 225.74,
        n: 915,
        o: 225.9,
        t: "2024-08-28T18:00:00Z",
        v: 60835,
        vw: 226.196841,
      },
      {
        c: 226.395,
        h: 227.635,
        l: 226.26,
        n: 1597,
        o: 227.24,
        t: "2024-08-28T19:00:00Z",
        v: 108865,
        vw: 226.985741,
      },
      {
        c: 231.5,
        h: 231.65,
        l: 228.89,
        n: 1985,
        o: 230.1,
        t: "2024-08-29T13:00:00Z",
        v: 173094,
        vw: 230.523035,
      },
      {
        c: 232.39,
        h: 232.72,
        l: 230.32,
        n: 2398,
        o: 231.845,
        t: "2024-08-29T14:00:00Z",
        v: 205839,
        vw: 231.630378,
      },
      {
        c: 231.67,
        h: 232.92,
        l: 231.5,
        n: 2066,
        o: 232.39,
        t: "2024-08-29T15:00:00Z",
        v: 162098,
        vw: 232.240894,
      },
      {
        c: 232.56,
        h: 232.67,
        l: 231.63,
        n: 1622,
        o: 231.665,
        t: "2024-08-29T16:00:00Z",
        v: 106485,
        vw: 232.146168,
      },
      {
        c: 231.75,
        h: 232.555,
        l: 231.38,
        n: 1239,
        o: 232.36,
        t: "2024-08-29T17:00:00Z",
        v: 77394,
        vw: 231.947276,
      },
      {
        c: 230.42,
        h: 231.68,
        l: 229.85,
        n: 1497,
        o: 231.62,
        t: "2024-08-29T18:00:00Z",
        v: 93232,
        vw: 230.755777,
      },
      {
        c: 229.83,
        h: 230.74,
        l: 229.35,
        n: 2263,
        o: 230.365,
        t: "2024-08-29T19:00:00Z",
        v: 144386,
        vw: 230.035918,
      },
      {
        c: 229.085,
        h: 230.38,
        l: 228.82,
        n: 915,
        o: 230.23,
        t: "2024-08-30T13:00:00Z",
        v: 87255,
        vw: 229.787124,
      },
      {
        c: 228.745,
        h: 230,
        l: 228.6,
        n: 1614,
        o: 229.15,
        t: "2024-08-30T14:00:00Z",
        v: 106720,
        vw: 229.148441,
      },
      {
        c: 228.59,
        h: 228.98,
        l: 227.545,
        n: 1733,
        o: 228.51,
        t: "2024-08-30T15:00:00Z",
        v: 116453,
        vw: 228.266501,
      },
      {
        c: 228.37,
        h: 228.81,
        l: 227.5,
        n: 1086,
        o: 228.17,
        t: "2024-08-30T16:00:00Z",
        v: 68642,
        vw: 228.024905,
      },
      {
        c: 227.7,
        h: 228.65,
        l: 227.7,
        n: 698,
        o: 228.395,
        t: "2024-08-30T17:00:00Z",
        v: 38611,
        vw: 228.159391,
      },
      {
        c: 228.55,
        h: 228.69,
        l: 227.69,
        n: 1384,
        o: 227.78,
        t: "2024-08-30T18:00:00Z",
        v: 106292,
        vw: 227.892477,
      },
      {
        c: 228.88,
        h: 229.84,
        l: 228.25,
        n: 2357,
        o: 228.55,
        t: "2024-08-30T19:00:00Z",
        v: 207740,
        vw: 228.915434,
      },
      {
        c: 226.17,
        h: 229,
        l: 225.36,
        n: 1422,
        o: 228.59,
        t: "2024-09-03T13:00:00Z",
        v: 114428,
        vw: 226.63205,
      },
      {
        c: 223.61,
        h: 226.465,
        l: 223.54,
        n: 2164,
        o: 226.15,
        t: "2024-09-03T14:00:00Z",
        v: 139255,
        vw: 224.844186,
      },
      {
        c: 223.515,
        h: 224.65,
        l: 223.28,
        n: 1459,
        o: 223.665,
        t: "2024-09-03T15:00:00Z",
        v: 94296,
        vw: 224.044205,
      },
      {
        c: 223.67,
        h: 224.29,
        l: 223.44,
        n: 1024,
        o: 223.63,
        t: "2024-09-03T16:00:00Z",
        v: 62139,
        vw: 223.813016,
      },
      {
        c: 223.2,
        h: 224.09,
        l: 223.19,
        n: 907,
        o: 223.74,
        t: "2024-09-03T17:00:00Z",
        v: 50336,
        vw: 223.657362,
      },
      {
        c: 221.94,
        h: 223.3,
        l: 221.85,
        n: 1712,
        o: 223.3,
        t: "2024-09-03T18:00:00Z",
        v: 119333,
        vw: 222.444935,
      },
      {
        c: 222.72,
        h: 222.72,
        l: 221.24,
        n: 3807,
        o: 221.95,
        t: "2024-09-03T19:00:00Z",
        v: 312906,
        vw: 222.182629,
      },
      {
        c: 221.82,
        h: 221.82,
        l: 221.82,
        n: 1,
        o: 221.82,
        t: "2024-09-03T20:00:00Z",
        v: 100,
        vw: 221.82,
      },
      {
        c: 219.495,
        h: 221.75,
        l: 219.05,
        n: 1727,
        o: 221.72,
        t: "2024-09-04T13:00:00Z",
        v: 261967,
        vw: 219.956539,
      },
      {
        c: 219.45,
        h: 219.55,
        l: 217.49,
        n: 3888,
        o: 219.53,
        t: "2024-09-04T14:00:00Z",
        v: 398321,
        vw: 218.545061,
      },
      {
        c: 219.25,
        h: 220.245,
        l: 218.04,
        n: 1568,
        o: 219.46,
        t: "2024-09-04T15:00:00Z",
        v: 112399,
        vw: 219.080874,
      },
      {
        c: 220.215,
        h: 220.215,
        l: 219.14,
        n: 1371,
        o: 219.345,
        t: "2024-09-04T16:00:00Z",
        v: 110893,
        vw: 219.716296,
      },
      {
        c: 220.87,
        h: 220.89,
        l: 219.82,
        n: 1259,
        o: 220.155,
        t: "2024-09-04T17:00:00Z",
        v: 87863,
        vw: 220.339854,
      },
      {
        c: 220.53,
        h: 221.13,
        l: 220.43,
        n: 1058,
        o: 220.87,
        t: "2024-09-04T18:00:00Z",
        v: 60134,
        vw: 220.790138,
      },
      {
        c: 220.73,
        h: 221.41,
        l: 220.17,
        n: 2738,
        o: 220.49,
        t: "2024-09-04T19:00:00Z",
        v: 244239,
        vw: 220.660274,
      },
      {
        c: 224.72,
        h: 224.92,
        l: 221.64,
        n: 1045,
        o: 221.64,
        t: "2024-09-05T13:00:00Z",
        v: 87068,
        vw: 223.429774,
      },
      {
        c: 223.73,
        h: 225.47,
        l: 223.67,
        n: 1475,
        o: 224.88,
        t: "2024-09-05T14:00:00Z",
        v: 113566,
        vw: 224.727797,
      },
      {
        c: 222.02,
        h: 223.855,
        l: 221.91,
        n: 1281,
        o: 223.73,
        t: "2024-09-05T15:00:00Z",
        v: 128863,
        vw: 222.919332,
      },
      {
        c: 222.89,
        h: 223.12,
        l: 221.97,
        n: 1088,
        o: 221.98,
        t: "2024-09-05T16:00:00Z",
        v: 72036,
        vw: 222.575371,
      },
      {
        c: 223.57,
        h: 223.72,
        l: 222.38,
        n: 814,
        o: 222.82,
        t: "2024-09-05T17:00:00Z",
        v: 68429,
        vw: 223.029504,
      },
      {
        c: 223.33,
        h: 223.845,
        l: 223.21,
        n: 927,
        o: 223.7,
        t: "2024-09-05T18:00:00Z",
        v: 63784,
        vw: 223.50984,
      },
      {
        c: 222.29,
        h: 223.37,
        l: 221.825,
        n: 1859,
        o: 223.3,
        t: "2024-09-05T19:00:00Z",
        v: 132117,
        vw: 222.411524,
      },
      {
        c: 224.045,
        h: 225.23,
        l: 222.84,
        n: 1574,
        o: 223.94,
        t: "2024-09-06T13:00:00Z",
        v: 198769,
        vw: 224.389342,
      },
      {
        c: 221.4,
        h: 224.74,
        l: 220.94,
        n: 2582,
        o: 224.01,
        t: "2024-09-06T14:00:00Z",
        v: 239775,
        vw: 222.974248,
      },
      {
        c: 220.96,
        h: 222.54,
        l: 220.84,
        n: 1802,
        o: 221.41,
        t: "2024-09-06T15:00:00Z",
        v: 147011,
        vw: 221.534301,
      },
      {
        c: 220.75,
        h: 221.33,
        l: 220.47,
        n: 1315,
        o: 220.96,
        t: "2024-09-06T16:00:00Z",
        v: 94155,
        vw: 220.846138,
      },
      {
        c: 220.21,
        h: 221.61,
        l: 220.11,
        n: 1136,
        o: 220.67,
        t: "2024-09-06T17:00:00Z",
        v: 89664,
        vw: 221.021064,
      },
      {
        c: 220.49,
        h: 220.63,
        l: 219.83,
        n: 1113,
        o: 220.29,
        t: "2024-09-06T18:00:00Z",
        v: 61206,
        vw: 220.199395,
      },
      {
        c: 220.95,
        h: 221.46,
        l: 220.165,
        n: 2959,
        o: 220.53,
        t: "2024-09-06T19:00:00Z",
        v: 218949,
        vw: 220.902033,
      },
    ];
    /* const transformed = testData.map((bar: any) => {
      bar.t = new Date(bar.t);
      return bar;
    });
    
 */
    const transformed = testData.map((bar: any) => {
      return [new Date(bar.t), bar.l, bar.o, bar.c, bar.h];
    });

    setData(transformed as any);
  }, []);

  useEffect(() => {
    if (!data || data.length === 0) return;

    const svg = d3.select(svgRef.current);
    svg.selectAll("*").remove(); // Clear previous chart content

    const margin = { top: 20, right: 30, bottom: 30, left: 40 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    // Define the time scale
    const x = d3
      .scaleTime()
      .domain([
        d3.min(data, (d: any) => new Date(d.t))!,
        d3.max(data, (d: any) => new Date(d.t))!,
      ]) // Assuming d.t is a timestamp or Date object
      .range([0, chartWidth]);

    // Define the y scale (assuming you are using a scale for the price range)
    const y = d3
      .scaleLinear()
      .domain([d3.min(data, (d: any) => d.l)!, d3.max(data, (d: any) => d.h)!])
      .range([chartHeight, 0]);

    const xAxis = d3
      .axisBottom(x) // Axis using numeric scale
      .ticks(data.length) // Adjust the number of ticks based on your data length
      .tickFormat(d3.format(".0f")); // Use a numeric format (e.g., no decimals)
    const yAxis = d3.axisLeft(y);

    // Append chart group
    const chart = svg
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Draw axes
    const xAxisGroup = chart
      .append("g")
      .attr("class", "x-axis")
      .attr("transform", `translate(0,${chartHeight})`)
      .call(xAxis);

    const yAxisGroup = chart.append("g").attr("class", "y-axis").call(yAxis);

    // Draw candlesticks
    // Adjust the drawCandlesticks function
    const drawCandlesticks = (data: any) => {
      // Calculate the width of each candlestick (optional, adjust as needed)
      const candleWidth = (x(new Date(data[1].t)) - x(new Date(data[0].t))) / 2;

      // Draw high-low lines (candlesticks)
      chart
        .selectAll(".candle")
        .data(data)
        .join("line")
        .attr("class", "candle")
        .attr("x1", (d: any) => x(new Date(d.t)) - candleWidth / 2) // Position based on time scale
        .attr("x2", (d: any) => x(new Date(d.t)) + candleWidth / 2)
        .attr("y1", (d: any) => y(d.h))
        .attr("y2", (d: any) => y(d.l))
        .attr("stroke", "black");

      // Draw open-close rectangles (candlestick bodies)
      chart
        .selectAll(".rect")
        .data(data)
        .join("rect")
        .attr("class", "rect")
        .attr("x", (d: any) => x(new Date(d.t)) - candleWidth / 2) // Position based on time scale
        .attr("y", (d: any) => y(Math.max(d.o, d.c)))
        .attr("width", candleWidth) // Use calculated width for candlesticks
        .attr("height", (d: any) => Math.abs(y(d.o) - y(d.c)))
        .attr("fill", (d: any) => (d.o > d.c ? "red" : "green"));
    };

    drawCandlesticks(data);

    const zoom = d3
      .zoom<SVGSVGElement, unknown>()
      .scaleExtent([1, 5]) // Set zoom limits
      .translateExtent([
        [0, 0],
        [chartWidth, chartHeight],
      ]) // Limit panning
      .extent([
        [0, 0],
        [chartWidth, chartHeight],
      ])
      .on("zoom", (event) => {
        console.log("Zoom event transform:", event.transform);

        const transform = event.transform;

        // Ensure transform exists and rescaleX can be called
        if (transform && transform.rescaleX && x) {
          const updatedX = transform.rescaleX(x); // Apply zoom scaling to the x-axis

          // Define tick formatting function for dates
          const dateTickFormat = (domainValue: Date) =>
            d3.timeFormat("%b %d")(domainValue);

          // Create x-axis with updated scale and tick format
          const updatedXAxis = d3
            .axisBottom<Date>(updatedX)
            .tickFormat(dateTickFormat);
          xAxisGroup.call(updatedXAxis);

          // Update the position of the candlestick elements
          chart
            .selectAll(".candle")
            .attr("x1", (d: any) => updatedX(d.t) - 2) // Assuming a fixed width for candlesticks
            .attr("x2", (d: any) => updatedX(d.t) + 2); // Same as above, adjust for width

          chart
            .selectAll(".rect")
            .attr("x", (d: any) => updatedX(d.t) - 2) // Adjust for width
            .attr("width", 4); // Fixed width for rects (adjust as needed)
        } else {
          console.error(
            "Transform or rescaleX is missing. Ensure that the x scale is initialized."
          );
        }
      });

    // Attach zoom behavior to the SVG element
    svg.call(zoom as any);
  }, [data, width, height]);

  return <svg ref={svgRef} width={width} height={height}></svg>;
};

export default CandlestickChart;
